
#!/usr/bin/env python3
"""
voice-typist: شنیدن میکروفون و تایپ متن تشخیص‌داده‌شده در پنجره‌ی فعال.
استفاده: اجرای این اسکریپت و سپس فشار دادن Ctrl+Shift+S برای شروع/توقف گوش دادن.
توجه امنیتی: فقط روی دستگاهی که اجازه استفاده از آن را دارید اجرا کنید.
"""

import time
import threading
import sys

import speech_recognition as sr
import pyautogui
from pynput import keyboard

# تنظیمات
HOTKEY_START_STOP = {keyboard.Key.ctrl_l, keyboard.Key.shift, keyboard.KeyCode(char='s')}
LANG = "fa-IR"  # زبان مورد نظر برای تشخیص گفتار (فارسی). می‌توانید "en-US" یا دیگران را بگذارید.
PAUSE_BETWEEN_TYPING = 0.01  # فاصله‌ی بین کاراکترها هنگام تایپ (ثانیه)
USE_GOOGLE = True  # اگر False بخواهد روش‌های آفلاین دیگر استفاده شود، باید تغییر دهید.

class VoiceTypist:
    def __init__(self, lang=LANG):
        self.recognizer = sr.Recognizer()
        self.lang = lang
        self.listening = False
        self._stop_flag = threading.Event()

    def start_listening(self):
        if self.listening:
            print("در حال حاضر در حالت گوش دادن هستیم.")
            return
        self.listening = True
        self._stop_flag.clear()
        t = threading.Thread(target=self._listen_loop, daemon=True)
        t.start()
        print("شروع گوش دادن. برای توقف دوباره کلیدهای راه‌انداز را فشار دهید یا Ctrl+C.")

    def stop_listening(self):
        if not self.listening:
            print("الان در حالت گوش دادن نیستیم.")
            return
        self._stop_flag.set()
        self.listening = False
        print("گوش دادن متوقف شد.")

    def _listen_loop(self):
        mic = sr.Microphone()
        with mic as source:
            # کالیبراسیون محیطی (اختیاری، بهتر است در محیط ساکت انجام شود)
            print("کالیبره کردن نویز محیط — لطفاً چند ثانیه سکوت کنید...")
            self.recognizer.adjust_for_ambient_noise(source, duration=1.5)
            print("کالیبراسیون تمام شد.")
            while not self._stop_flag.is_set():
                try:
                    print("گوش دادن...")
                    audio = self.recognizer.listen(source, timeout=5, phrase_time_limit=8)
                except sr.WaitTimeoutError:
                    # اگر هیچ ورودی صوتی نیامد، حلقه را ادامه می‌دهیم
                    continue

                # تبدیل گفتار به متن
                text = None
                try:
                    if USE_GOOGLE:
                        # از Google Web Speech API استفاده می‌کنیم (نیاز به اینترنت)
                        text = self.recognizer.recognize_google(audio, language=self.lang)
                    else:
                        # می توانید اینجا مدل آفلاین یا pocketsphinx قرار دهید
                        text = self.recognizer.recognize_sphinx(audio, language=self.lang)
                except sr.UnknownValueError:
                    print("قابل تشخیص نیست.")
                    continue
                except sr.RequestError as e:
                    print("خطای سرویس تشخیص گفتار:", e)
                    print("مطمئن شوید اتصال اینترنت دارید یا USE_GOOGLE=False را بگذارید.")
                    continue

                if text:
                    print("تشخیص داده شد:", text)
                    self._type_text(text)
                time.sleep(0.2)

    def _type_text(self, text):
        # تایپ متن در پنجره/input فعلی
        try:
            # اگر می‌خواهید Enter بفرستید در انتها: pyautogui.press("enter")
            pyautogui.write(text, interval=PAUSE_BETWEEN_TYPING)
        except Exception as e:
            print("خطا هنگام تایپ خودکار:", e)


# مدیریت هات‌کی برای شروع/توقف
class HotkeyController:
    def __init__(self, voice_typist):
        self.voice_typist = voice_typist
        self.current_keys = set()

    def on_press(self, key):
        try:
            if key in HOTKEY_START_STOP or (isinstance(key, keyboard.KeyCode) and key.char and 's' == key.char):
                self.current_keys.add(key)
        except Exception:
            pass

        # بررسی اینکه همه کلیدهای مورد نیاز فشرده شده‌اند
        if all(k in self.current_keys for k in HOTKEY_START_STOP):
            # toggle
            if self.voice_typist.listening:
                self.voice_typist.stop_listening()
            else:
                self.voice_typist.start_listening()

    def on_release(self, key):
        if key in self.current_keys:
            self.current_keys.remove(key)


def main():
    vt = VoiceTypist()
    controller = HotkeyController(vt)
    listener = keyboard.Listener(on_press=controller.on_press, on_release=controller.on_release)
    listener.start()
    print("Voice-typist آماده است. از کلید Ctrl+Shift+S برای شروع/توقف استفاده کنید.")
    try:
        while True:
            time.sleep(0.5)
    except KeyboardInterrupt:
        print("\nخروج... متوقف کردن.")
        vt.stop_listening()
        listener.stop()
        sys.exit(0)


if __name__ == "__main__":
    main()
